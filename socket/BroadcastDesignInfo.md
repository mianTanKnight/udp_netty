############################################################# UDP通信规则和实现方案 ###############################################################
##基本通信规则
UDP通信规则定义了数据包的结构和传输方式。这包括固定长度的帧头和随后的数据内容。帧头包含如设备ID、命令字、参数等关键信息。

##UDP通信难点
不保证数据包顺序：UDP协议本身不保证数据包的顺序和可靠性。
数据分帧传输：对于大数据块的处理，需要将数据分成多个帧进行传输。
超时和丢包处理：由于UDP的不可靠性，必须处理数据丢包和超时的情况。
##解决方案
#1. 数据帧序列追踪
   每个数据帧都被赋予一个唯一的序列号（SN），用于跟踪数据帧的顺序。
   接收端根据序列号重组分散的数据帧，确保数据的完整性。
#2. 多帧数据处理
   大数据块被分为多个帧进行传输。
   使用 multiFrameMes 对象来累积和重组分帧数据。
#3. 超时机制实现
   采用“惰性超时检测”机制，减少不必要的性能开销。
   仅在数据阻塞或等待期间检查超时，而不是周期性检查。
#4. Netty框架使用
   利用Netty进行高效的异步网络编程。
   Netty提供了更好的数据包处理、异常管理和资源控制。
#5. 并发控制
   使用Java并发锁（ReentrantLock）确保命令处理的原子性。
   通过条件变量（Condition）控制线程的等待和通知。
#6. 配置管理
   Spring框架用于灵活地管理配置，例如服务器地址、端口等。
   使用Spring的依赖注入机制简化了配置和代码间的管理。
#7. 异常处理和日志记录
   详细的异常捕获和日志记录，以便于问题的快速定位和解决。
   Netty的异常处理机制用于捕获和处理网络层面的异常

##实现细节

#BroadcastClient 类
职责：该类负责建立和管理UDP连接，发送和接收数据包。
关键方法：
sendCommandOfLock：保证UDP命令发送的原子性。
sendCommand：发送UDP数据包。
checkTimeOut：检查操作是否超时，并执行回调。
超时监听：使用 timeOutCallBack 和 timeOutListenObj 管理超时。

#BroadcastUDPMesHandler 类
职责：处理Netty通道中的UDP数据包。
关键方法：
channelRead0：处理接收到的UDP数据包。
sendNextData：请求发送下一个数据帧。
pushNextHandle：处理组合数据。
超时和并发控制
使用 ReentrantLock 和 Condition 控制并发访问和线程等待/通知机制。
实现了基于当前系统时间的简单超时机制，与Netty的事件循环相结合。


#BusinessLogicHandler 类
职责：根据完整UPD数据包处理业务


#BroadCast 通信规则说明
通用帧结构: 每个 UDP 包包含一个固定长度的帧头和随后的数据。 帧头长度为 16 字节，即 32 个十六进制字符。 
帧头格式 (小端存储)：
偏移量(字节)   定义
0-2         帧起始标志 (0xFE 0xE0,0xA7)
3           数据包类型 (Type: 0x8A 或 0x8B)
4-7         设备ID (DID)
8-9        帧序列号 (SN)
10-11       数据长度 (Len)
12          命令字 (Cmd)
13          参数 (Para)
14          应答标志(Accept)
15          校验和 (ChkSum)
**详细说明:**
- Type: 标识发送方和接收方。
  0x8A 表示第三方软件发给中间件的帧。
  0x8B 表示中间件发给第三方软件的帧。
- DID: 设备ID，4字节，某些命令下可为0。
- SN: 帧序列号，4字节，用于跟踪帧的顺序。
- Len: 数据长度，2字节，表示帧头后的数据长度。
- Cmd: 命令字，1字节，定义操作类型。
- Para: 参数，1字节，与命令字结合使用。
- Accept/ChkSum: 应答标志或校验和，1字节。
**发送规则:**
- 第三方软件向中间件发送帧时，Type 设置为 0x8A。
- 帧头中包含必要的控制信息，如设备ID、命令字等。
**接收规则:**
- 接收到的帧中，Type 应为 0x8B。
- 应答帧的帧序列号 (SN) 应与发送帧匹配。
- Accept 字段表明中间件是否接受了命令。
**注意:**
- 适当处理大数据块的分帧传输。
- 确保每个字段按照小端格式编码。

**多桢传输:**
多帧数据传输：当中间件需要发送大量数据时，它会分多个帧进行传输。这种情况通常发生在数据量大到无法在单个 UDP 数据包中发送时。
帧序列号 (SN) 的作用：每个帧都有一个序列号，这对于追踪多帧数据的顺序非常重要。尤其是在多帧数据传输中，序列号帮助接收方正确地组装这些分散的数据帧。
数据帧的开始与结束：
开始：中间件发送的第一个数据帧被标记为 0x8D SendData。
后续帧的请求：第三方软件通过发送 0x80 SendNextData 命令来请求后续的数据帧。
结束：最后一个数据帧的序列号的特定位（比如 SN 的 bit15）被设置为 1，表明数据传输结束。
数据传输确认：中间件通过应答帧确认收到的命令。这些应答帧包含与命令帧相同的 Cmd、Para 和 SN，但 Type 字段为 0x8B。Accept 字段为 0 表明命令被接受。
